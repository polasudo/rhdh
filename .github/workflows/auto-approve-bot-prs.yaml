# Copyright Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Auto-Approve Bot PRs

# This workflow automatically adds labels and approves PRs that match specific criteria:
# - Created by rhdh-bot (via RHDH GitHub App)
# - Branch name matches specific patterns (base image updates, version bumps, etc.)
# - Adds lgtm and approved labels if not present

on:
  pull_request_target:
    types: [opened, reopened, labeled, ready_for_review]
  push:
    branches:
      - 'fix/auto-approve-bot'  # For testing in fork

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  auto-approve:
    name: Auto-Approve and Label PRs
    runs-on: ubuntu-latest
    
    # Only run if PR is from rhdh-bot
    if: github.event.pull_request.user.login == 'rhdh-bot'
    
    steps:
      - name: Check PR eligibility
        id: check-eligibility
        run: |
          # Handle both push and pull_request_target events
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PR_BRANCH="${{ github.ref_name }}"
            PR_DRAFT="false"
          else
            PR_BRANCH="${{ github.event.pull_request.head.ref }}"
            PR_DRAFT="${{ github.event.pull_request.draft }}"
          fi
          
          # Don't auto-approve draft PRs
          if [[ "$PR_DRAFT" == "true" ]]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "reason=PR is in draft state" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Labels will be added automatically if eligible
          
          # Define branch patterns that are eligible for auto-approval
          # Add more patterns as needed
          ELIGIBLE_PATTERNS=(
            "^chore/automated-.*"
            "^fix/auto-approve-bot$"
          )
          
          ELIGIBLE=false
          for pattern in "${ELIGIBLE_PATTERNS[@]}"; do
            if [[ "$PR_BRANCH" =~ $pattern ]]; then
              ELIGIBLE=true
              break
            fi
          done
          
          if [[ "$ELIGIBLE" == "true" ]]; then
            echo "eligible=true" >> $GITHUB_OUTPUT
          else
            echo "eligible=false" >> $GITHUB_OUTPUT
          fi


      - name: Add required labels and approve PR
        if: steps.check-eligibility.outputs.eligible == 'true' && (github.event_name == 'pull_request_target' || github.event_name == 'push')
        run: |
          # For testing on push events, use test PR #2
          PR_NUMBER="${{ github.event.pull_request.number }}"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            PR_NUMBER="2"  # Test PR in fork
            echo "ðŸ§ª TESTING: Using test PR #$PR_NUMBER for demonstration"
          fi

          # Add the required labels if not already present
          echo "Adding labels to PR #$PR_NUMBER..."
          gh pr edit $PR_NUMBER --add-label "lgtm,approved" --repo ${{ github.repository }}

          # Auto-approve the PR
          echo "Auto-approving PR #$PR_NUMBER..."
          gh pr review $PR_NUMBER \
            --approve \
            --body "**Auto-Approved**

          This PR has been automatically approved by the auto-approve workflow.

          **Labels Added:** \`lgtm\`, \`approved\`" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

